#!/bin/env bash

# List all repositories in the current account sorted by lastModeifiedDate (oldest first), and their branches sorted by commit.commiter.date (newest first)

for repo in $(
    aws codecommit list-repositories --query 'repositories[].repositoryName' --output text;
); do
    echo -n $(aws codecommit get-repository --query 'repositoryMetadata.[repositoryName,lastModifiedDate]' --output text --repository-name $repo)" ";
    # list branches in commit-date order - latest first
    echo $(
        for branch in $(
            aws codecommit list-branches --repository-name $repo --query 'branches' --output text;
        ); do
            echo -n $branch" ";
            aws codecommit get-branch --repository-name $repo --query 'branch.commitId' --output text --branch-name $branch |
            xargs -n 1 aws --output text codecommit get-commit --repository-name $repo --query 'commit.committer.date' --commit-id |
            cut -d" " -f1;
        done |
        sort -rk2 |
        cut -d" " -f 1
    ) |
    column -to ";";
done |
awk '{$2=$2" "strftime("%D %T %Z",$2); print}' |
sort -k2 |
column -to " " |
sed 's/;/ /g';

